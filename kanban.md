# カンバン

---

## 処理

### screenshotの変更

+ 作業範囲：HTML/WordPress

テーマのスクリーンショットを変更、それに伴い下記も変更

+ GitHubのREADMEサムネイル
+ GitHub Pages の ReadME のサムネイル

### サムネイル関係の修正

+ 作業範囲：CSS/WordPress

カードのサムネイル画像はCSSに`object-fit: cover;` を使っているため一部が切り取られている。
記事ページのサムネイルは全体が見えるよう、`object-fit: contain;` に変更をかけた。

なお、WordPress側でサムネイル画像が余りに荒い問題に気付いた。これはサイズ指定に使っていた `thumbnail` が既存のサイズであり、そのため `150x150` のサイズとなっていた。  
今回はサイズ名に接頭辞 `zkr-` をつけ別として認識するよう対処している。

## 処理途中

---

## 未処理

### timeタグの読み上げについて調査

+ 作業範囲：HTML/CSS

Voiceover(iOS)で読み上げ時、記事の情報欄 `投稿：2023/07/01` を
「投稿コロン2023スラッシュ07スラッシュ01、2023年7月1日」と読み上げている。
コロンを読み上げないようにし、同じ内容を2回繰り返さないようにはできないか？

### template

+ 親：[txt](#アドレスウィジェットの改修)
+ 作業範囲：HTML/CSS/Javascript/WordPress

作業内容

---

## 保留・構想

### ブロックスキップ

+ 作業範囲：HTML

Voiceover(iOS)使用時、ブロックスキップを使用しようとリンクを踏むと、何故かヘッダーに移動してしまう。
フォーカス可能な要素でないからなのか、原因が特定できていない状態。Web上で関連する情報を調べていく。

### ブロックエディタによる記事データとカラーモード

構想の1つとしては、対象となる要素内の `color` と`backgrond-color` からコントラスト比を算出し、
コントラスト比が低い場合には適切な色へ変更するよう、Javascript で機能を作ること。

厳密に行くなら、文字サイズの大小や、ボーダーの有無など、様々な状況が考えられる。

実装例はネット上でいくつか見つけられるが、「リンクは青」「警告は赤」といった色情報は残したいので、
例えば 5色＋白黒くらいの色数で枠を作り、それぞれに複数の明度を用意し、そこから選んでいく方法とかどうだろう？

ただ、これを作る理由としては「カラーモードの切り替えで `body` 要素の `background` が変わることで、文字が見えなくなってしまう」こと
である以上、それに寄らない要因（例えばブロック自体に背景色を設定しているもの）まで変えるのは良くないと思う。

## 除外

---

## 処理済

### ダイアログのスタイル修正

+ 作業範囲：CSS/WordPress

`.ly_dialog *:first-child{}` と その前後のスタイリングについて、子孫セレクタでなく子セレクタが正しいと思われる。
あの辺りをもう一度チェックし、修正する。

### カードのスタイル修正

+ 作業範囲：CSS/WordPress

`.bl_card` に `position` があるのは、試作の中で入れたものであり、現在は不要のはず。
確認し、不要なスタイルは削除する。

### Pages上のブロックスキップを修正

+ 作業範囲：HTML

WordPressでは条件分岐でブロックスキップの要素を調整しているが、HTML側はそれができないためリンク先を持たない要素が存在している。
各ページのブロックスキップを確認し、不要なリンク要素はコメント化しておく。

### 投稿ページの記事情報欄に

+ 作業範囲：HTML/WordPress

カードで更新日を扱うように変えたので、投稿ページも同じように変更する。
変更する場所は `.bl_postData` の要素。

作業における追記

+ 更新日に関してはリンクを付与しない（投稿日と違い、更新月のアーカイブを採用していないため）
+ そのため、構造が `a`タグを挟むか `time`タグのみになるかの違いが生じた
+ `bl_postData` はタグ、カテゴリにも使用しており、細かな設定は設計上よろしくないと判断
+ いっそ共通化できるのではと考え、`bl_postData_name`, `bl_postData_values` の使い方を統一した
+ そのため `bl_postData_value` の追加等、CSSの設計を一部変更した
+ HTML上で確認し、問題なかったため、WordPressにも反映
+ この際、`the_category` と `the_tags` で書き方が大きく違っていたため、改修しやすいようにコードを変更している

### 検索件数の表示

+ 作業範囲：HTML/CSS

検索ページの `「＊＊＊」の検索結果` の欄に、何件ヒットしたかの情報を追加する。

### 検索件数機能をWordPressに反映

+ 親：[検索件数の表示(HTML)](#検索件数の表示)
+ 作業範囲：WordPress

HTMLで作成した内容を、WordPress側に落とし込む

### FontSizeChangerの改修

+ 作業範囲：Javascript/WordPress

`sessionStorage` を使い、フォントサイズの設定情報をセッション中に維持するようにする。

### コンポーネント集の「記事情報」を更新

+ 親：[投稿ページの記事情報欄に](#投稿ページの記事情報欄に)
+ 作業範囲：HTML

`page.html` にあるコンポーネント集、そこの記事情報欄の箇所が更新されていないので、更新する。

### HTML構造の修正（`div`）

+ 作業範囲：HTML/WordPress

`bl_debToolBox_utils` の `div`タグが閉じられていないため構成がおかしくなっている部分を修正

### `js_pageTop`のスタイル微修正

+ 作業範囲：CSS/WordPress

ホバーやメディアクエリのスタイルが前の状態のまま（`#pagetop`）なので、正しい形に修正

### `bl_accordion`のスタイル修正

+ 作業範囲：CSS/WordPress

現在はCSS `.bl_accordion_summary::after` の `background-image` で色を指定したSVGを使用している。  
ダークモード用に、色値のみ変えたSVGをもう一つ使っているが、保守性が低い。  
`filter: invert(1);` で検証し、問題なければ差し替える。

### `input`要素の修正

+ 作業範囲：HTML/WordPress

一部の`input`要素で、`name=""` と空欄にしている箇所があるので修正  
（name属性に大文字をつけないよう他も変更している）

### アドレスウィジェットの改修

+ 作業範囲：HTML/CSS

フッター右側のアドレス欄を整備する。

+ SNS欄はユーティリティリンクを使った手法に変更する
+ メールや住所、プライバシーポリシーやサイトマップなどを配置することを想定する

作業における追記

+ `bl_snsIcon` は使用しなくなったため、削除する

### カテゴリ・要旨出力制限設定（テーマカスタマイザー）をスライダーからセレクトに

+ 作業範囲：WordPress

現在スライダー（`'type'->'range'`）のコントロールを使っているが、これをセレクトに変更する。
理由は、微調整が必要なほど取りうる値が多くなく、そして現在値がスライダーではわからないため。

### アドレスウィジェットをWordPressに反映

+ 親：[アドレスウィジェットの改修(HTML)](#アドレスウィジェットの改修)
+ 作業範囲：WordPress

HTMLで作成した内容を基に、WordPressに落とし込む。

+ プライバシーポリシーやサイトマップ等は固定ページで作ることを考慮し、新たにカスタムメニューを作成する
+ メールや住所、SNS等はテーマカスタマイザーで編集できるようにする

作業における追記

+ 「ユーティリティウィジェット」という名前になった（アドレス以外も管理するため）
+ 新たにテキストエリアを設け、備考など自由に使える欄を用意した
+ 新たにコピーライト用のテキスト枠を設け、自由に記述できるようにした
+ template-parts/parts-sns.php は不要となったため削除

### 開発ツールのHTMLをテンプレートパーツにして切り離す

+ 作業範囲：WordPress

開発ツールのHTMLは現在 `footer.php` 内に入っているが、これをテンプレートパーツ化する。
これは最終的には不要になる部分なので、削除しやすい形（例：読み込み前にファイルの存在確認を行う）にしておく。

### `template-parts/parts-menu.php`の改修

+ 作業範囲：WordPress

現在はリンク要素を追加するだけであり、メニュータイトル等をつけることができない。

作業における追記

+ `wp_nav_menu()` 関数の扱い範囲を変える（コンテナ要素は外側で制作）
+ 外側でリストのタイトルを取り扱う（名前は引数で受け取る）

### ユーティリティウィジェットにメモ欄追加

+ 作業範囲：HTML/CSS/WordPress

サイトに関する注意事項や制作者紹介欄などに使えるよう、メモ欄を追加。  
WordPressでは、カスタマイザー上で取り扱う。

### タグメニューの改修

+ 作業範囲：HTML/WordPress

現在、スクリーンリーダー上で `span` 要素はリストのタイトルとは認識されない。  
また、`ul` 要素のみではリストとして認識されないブラウザがあり動作が統一されてない状態。

+ `ul` 要素は Safari 上でリストとして認識されないので、`role="list"` で共通した動きにする
+ `ul` 要素には `aria-labelledby` を使用し、ラベル付けを行う
+ `span`要素には `aria-hidden` を使用し、タイトルを繰り返し読み上げないようにする

### `js_pageTop`の改修

+ 作業範囲：HTML/CSS/Javascript/WordPress

現在は Javascript で `Opacity` を調整することで、一定のマウススクロールを行わないと見えなくしている。  
これは実際には存在し触れてしまう状態なので、何かしらの方法で対処する。

1. `hidden` 属性を利用する？
2. JavaScriptでなく、CSSで表示/非表示のアニメーションを表現（`Keyframe` もしくは `transition`）
3. `disabled` 属性を利用し、スタイルで `display: none;` を設定

作業における追記

+ JavaScript上では `hidden` 属性のつけ外しを主の役割に変更
+ CSS上で `visibility` や `opacity` 等を管理するよう変更
+ フェードイン（アウト）用に `@keyframes` 使用
+ 以前と違い、消えている状態下ではボタンは触れなくなった

### `bl_accordion`の修正

+ 作業範囲：HTML/CSS/WordPress

現状は、`summary` タグ内に `a`タグを入れている。  
`summary` のロールはボタンであるので、その中にインタラクティブ要素である `a` が入ることはできない。  
（テキストノードと別にインライン的な要素を入れても、その部分は無視されるらしい）

`summary` 内は純粋にテキストのみとし、下記の諸問題を解決する

+ 親子関係があるものに関しては、`summary`内にリンクテキストを置くのではなく、格納された要素の1番目に置くようにする
+ `div` 直下で `li` を使っている箇所があり、構造的にエラーなので適切な形に修正
+ 上記の修正内容を、WordPressに反映

作業における追記

+ 中身として `ul`, `li` 要素を使うように変更
+ その関係で list のスタイルを打ち消す必要が生じ、`style.css` を改修

### ブロックスキップの問題解消

+ 作業範囲：HTML/CSS/Javascript

Safari(iOS) で Voiceover を使った際、ブロックスキップで移動（URLフラグメントを利用するページ内リンク）すると
リンク先には行かずヘッダーに移動してしまう。  
原因としてはフォーカスできない要素に移動していることが考えられる。そのため、下記の検証を行い改修を行っていく。

1. リンク先要素に `tabindex="-1"` を設置し、フォーカスを受け取れるようにしておく
2. 上記の検証が駄目だった場合、JSを使って解消できないかを検証していく

作業における追記

+ 1番の方法で Safari(iOS) Voiceover を操作したところ、問題が解消された。
+ フォーカス要素が表示され少し見栄えが悪くなる部分については、`focus-visible` の使用を検討する。
+ 上記はポリフィルとしてのJSファイルがあるので、`focus-visible` 利用時はこちらも導入すること

### footer最新の記事を修正

+ 作業範囲：WordPress

現在、各 `article` に `id="post-<?php the_ID(); ?>"` を使い、postデータが持つIDが割り振られている。  
`front-page.php` や `archive.php` を利用した際、そこに表示される記事とフッターにある記事とが同一になる可能性があり、
その場合同一ページに同一IDが出力されることになる。  
そこで、フッター側にある `article` には ID を設定しない。

### WordPressへブロックスキップの問題解消

+ 親：[ブロックスキップの問題解消](#ブロックスキップの問題解消)
+ 作業範囲：WordPress

HTML側で解消した内容を WordPress に反映する。

### ブロックスキップ関係のフォーカス修正

+ 親：[ブロックスキップの問題解消](#ブロックスキップの問題解消)
+ 作業範囲：CSS/WordPress

`id="anchor-*" tabindex="-1"` の箇所において、見栄えが悪くなる問題が発生している。  
これはレイアウト要素をフォーカス可能にした関係で、クリックするとレイアウト部にフォーカスが当たるようになったためである。

必要となる結果は、下記のとおりである。

+ クリックしてもレイアウトにフォーカスのアウトラインが発生しないこと
+ tabキーによる操作にはフォーカス時にアウトラインがあたること
+ ブロックスキップ時においては、アウトラインがあたった方が望ましい

これを基に、下記の検証と修正を行う。

1. 疑似クラス `focus-visible` を使いユーザーの入力方法に応じた使い分けを行う
2. `id="anchor-*"` で前方一致の要素に対しスタイルを追加

作業における追記

+ 1番の `focus-visible` の手法で必要な結果を達成できた
+ また、「ページトップに戻る」ボタン押下時にヘッダーにフォーカスがあたる問題も解消できた
+ 上記はTabキーを使った場合はヘッダーにフォーカスエフェクトが生じているので、より望ましくなっている

注意：比較的新しい機能のため、古いブラウザでは機能しない可能性がある。
そのため、検証し問題があるようなら再度修正を行う必要がある。
[MDNによれば、2022年3月移行のバージョンに対応しているらしい](https://developer.mozilla.org/ja/docs/Web/CSS/:focus-visible)

### 検索ページへのリンク方法を改修

+ 作業範囲：WordPress

現在はスラッグ `zkr-seachpage` を使用する方法を取っている。
パーマリンクの設定によってはこれが使えないので、別の方法を模索する。

今回は、固定ページを挟む手法自体を取りやめ、`search.php` のみで「検索ページ」「（検索実行時の）検索結果」を表現する。

検索ページへのリンク要素は、下記の３つ存在する

1. モバイル画面時のヘッダーにある「検索」ボタン（`a`タグ）
2. ダイアログ内の「サイト内検索」（`a`タグ）
3. 右サイドバー内の「サイト内検索」（`a`タグ）

これら3つは全て `a`タグを使用している。そのため、下記のような手法を用いる。

+ レンダリング、AOMから完全に隠した状態の `form`要素を作成
+ `a`タグの `href` 属性に、JavaScriptを用いてフォーム送信を実行するようにする
+ `search.php` 側にコードを追加し、リンクから飛んできた場合と検索実行時で表現を変える
+ リンクから飛んできた場合は、最新記事を5件表示状態、検索結果用の見出しは変更すること

作業における追記

+ `form` をAOM上無視されることを確認
+ Javascript文を `href` にいれた `a`タグは、AOMで `role="link"` だったので問題ないと判断
+ Windowsナレーターで簡易的に確認したが、読み上げの結果「検索、リンク」で問題はなかった
+ 使わなくなった `searchpage.php` は削除、`README.md` と `single.html` の手順紹介も合わせて変更
